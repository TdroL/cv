// Generated by CoffeeScript 1.3.3
var __slice=[].slice;$(function(){var e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N;return E=[],b=5,m=10,v=100,e=$("#canvas"),x=e.data("width"),h=e.data("height"),r=Raphael(e[0],x,h),f={},n={start:{out:{stroke:"#00f",fill:"rgba(0, 0, 255, 0.5)"},over:{stroke:"#00e",fill:"rgba(0, 0, 244, 0.3)"}},"default":{out:{stroke:"#f00",fill:"rgba(255, 0, 0, 0.5)"},over:{stroke:"#e00",fill:"rgba(244, 0, 0, 0.3)"}}},p="How to use:\n1. Click and drag to move points\n2. Click on lines to create new points\n3. Double-click on points to remove them\n4. The blue one is starting point and is immovable and unremovable\n\nFor optimal results keep all points within the big circle.",l=function(e,t,n){var r,i,s,o,u,a,f,l,c;e++,E=[];while(e-=1){r=2*Math.PI*Math.random(),o=(t-n)*Math.random()+n,l=o*Math.cos(r)+Math.sin(r),c=Math.cos(r)-o*Math.sin(r),a=[Math.round(l),Math.round(c)];if(E.length>1){u=E.length-2,i={x:a[0],y:a[1]},f={x:E[u][0],y:E[u][1]},s=(i.x-f.x)*(i.x-f.x)+(i.y-f.y)*(i.y-f.y);if(s<n*n*4){e++;continue}}E.push(a)}return E.splice(0,0,[0,0])},u=function(){var e,t,n,i,s,o,u;return t=x/2,n=h/2,e=v*1.25,(i=f["background"])!=null&&i.remove(),f.background=r.rect(0,0,x,h).attr({fill:"rgba(255, 255, 255, 0.8)","stroke-width":0}),(s=f["cross-lines"])!=null&&s.remove(),f["cross-lines"]=r.path("M"+(t-e)+","+n+"L"+(t+e)+","+n+"M"+t+","+(n-e)+"L"+t+","+(n+e)).attr({stroke:"#333"}),(o=f["cross-circle"])!=null&&o.remove(),f["cross-circle"]=r.circle(t,n,v).attr({stroke:"#333"}),(u=f["info"])!=null&&u.remove(),f.info=r.text(20,70,p).attr({color:"#333","font-size":16,"text-anchor":"start"})},c=function(){var e,t,n,r,i,s,o;o=E[E.length-1],n=o[0],r=o[1],t="M"+n+","+r;for(i=0,s=E.length;i<s;i++)e=E[i],n=e[0],r=e[1],t+="L"+n+","+r;return t},a=function(){var e,t;return(e=f["points-lines"])!=null&&e.remove(),f["points-lines"]=r.path(c()).attr({stroke:"#e00"}),(t=f["points-lines-clickable"])!=null&&t.remove(),f["points-lines-clickable"]=r.path(c()).click(d).attr({stroke:"rgba(0,0,0,0.0)","stroke-width":8})},d=function(t,n,r){var i,s,u,f,l,c,h,p,d,v,g,y,b,w,S,x,T,N;s=[],c=e.offset(),n=Math.round(n-c.left),r=Math.round(r-c.top),T=E.slice(0),T.push(T[0]),m=null,f=null;for(u=x=0,N=E.length;0<=N?x<N:x>N;u=0<=N?++x:--x){g=T[u+0][0],w=T[u+0][1],y=T[u+1][0],S=T[u+1][1];if(Math.min(y,g)<=n&&n<=Math.max(y,g)&&Math.min(S,w)<=r&&r<=Math.max(S,w)){p=y-g,d=S-w,l=p*p+d*d,h=((n-g)*p+(r-w)*d)/l;if(0<=h&&h<=1){v=g+h*(y-g),b=w+h*(S-w),i=(n-v)*(n-v)+(r-b)*(r-b);if(m===null||i<m)m=i,f=u}}}return E.splice(f+1,0,[n,r]),a(),o()},o=function(){var e,o,u,a,l,c,h,p;(p=f["points-bullets"])!=null&&p.forEach(function(e){return e.remove()}),f["points-bullets"]=[];for(o=c=0,h=E.length;c<h;o=++c)u=E[o],a=u[0],l=u[1],e=r.circle(a,l,5),o!==0?e.attr(n["default"].out).mouseover(y).mouseout(g).dblclick(t).drag(i,s):e.attr(n.start.out),e.data("isMouseOver",!1),e.data("i",o),e.data("timestamp",Date.now()),f["points-bullets"].push(e);return S()},s=function(){return this.data("cx",this.attr("cx")),this.data("cy",this.attr("cy"))},i=function(e,t){var n;return this.attr({cx:this.data("cx")+e,cy:this.data("cy")+t}),E=function(){var e,t,r,i;r=f["points-bullets"],i=[];for(e=0,t=r.length;e<t;e++)n=r[e],i.push([n.attr("cx"),n.attr("cy")]);return i}(),f["points-lines"].attr({path:c()}),f["points-lines-clickable"].attr({path:c()}),S(),this.data("timestamp",Date.now())},y=function(){if(this.data("isMouseOver")===!1)return this.attr(n["default"].over),this.data("isMouseOver",!0)},g=function(){if(this.data("isMouseOver")===!0)return this.attr(n["default"].out),this.data("isMouseOver",!1)},t=function(){var e;e=1<=arguments.length?__slice.call(arguments,0):[];if(Date.now()-this.data("timestamp")>500)return E.splice(this.data("i"),1),this.remove(),a(),o()},S=function(){var e,t,n,r;return n=x/2,r=h/2,e=function(){var e,i,s;s=[];for(e=0,i=E.length;e<i;e++)t=E[e],s.push(""+Math.round(t[0]-n)+" "+Math.round(t[1]-r));return s}(),$("#coords").val(e.join(", "))},l(b,v,m),T=x/2,N=h/2,E=function(){var e,t,n;n=[];for(e=0,t=E.length;e<t;e++)w=E[e],n.push([w[0]+T,w[1]+N]);return n}(),u(),a(),o(),$("#coords").keyup(function(){var e,t,n,r,i,s;e=$(this),n=e.val().trim().split(/\s*,\s*/);if(!n.length)return;/^0\s+0$/.test(n[0])||n.splice(0,0,"0 0"),E.splice(0),T=x/2,N=h/2;for(i=0,s=n.length;i<s;i++)t=n[i],r=t.split(/\s+/),r.length===2&&E.push([parseInt(r[0],10)+T,parseInt(r[1],10)+N]);return a(),o()})});